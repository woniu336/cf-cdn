# 上游服务配置（动态解析）
#upstream 111_xyz_backend {
#    server 后端域名:443;
#    keepalive 32;
#}

# 添加 upstream 配置,代理cloudflare则不用改动
upstream 111_xyz_backend {
    server 104.21.63.38:443 weight=3 max_fails=3 fail_timeout=10s;
    server 172.67.185.110:443 weight=1 max_fails=3 fail_timeout=10s;
    keepalive 32;
}


# HTTP 强制跳转 HTTPS
server {
    listen 80;
    server_name 线路域名 主域名;
    return 301 https://$host$request_uri;
}

# 线路域名 的 HTTPS 配置
server {
    listen 443 ssl;
	http2 on;
    server_name 线路域名;

    ssl_certificate /etc/nginx/certs/线路域名_cert.pem;
    ssl_certificate_key /etc/nginx/certs/线路域名_key.pem;

    location / {
        include /etc/nginx/conf.d/proxy_common.conf;
        proxy_pass https://111_xyz_backend;
        sub_filter '后端域名' '线路域名';
    }

    access_log /data/wwwlogs/线路域名.access.log main buffer=32k flush=5s;
    error_log /data/wwwlogs/线路域名.error.log error;
}

# 主域名 的 HTTPS 配置
server {
    listen 443 ssl;
	http2 on;
    server_name 主域名;

    ssl_certificate /etc/nginx/certs/主域名_cert.pem;
    ssl_certificate_key /etc/nginx/certs/主域名_key.pem;

    location / {
        include /etc/nginx/conf.d/proxy_common.conf;  
        proxy_pass https://111_xyz_backend;  
        sub_filter '后端域名' '主域名';
    }

    access_log /data/wwwlogs/主域名.access.log main buffer=32k flush=5s;
    error_log /data/wwwlogs/主域名.error.log error;
}